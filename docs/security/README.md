<p align="center"><img src="../img/lo.svg" width="260"></p>
<p align="center">

# Logging-operator && Security

---
## Contents
- **Using RBAC Authorization**
    - [Deploy with Kubernetes Manifests](#deploy-with-kubernetes-manifests)
    - [Deploy with Helm](#deploy-with-helm)
    - [Output](#example-manifest-generated-by-the-operator)
- **Service Account**  
    - [Deploy with Kubernetes Manifests](#deploy-with-kubernetes-manifests-1)
    - [Deploy with Helm](#deploy-with-helm-1)
- **Pod Security Policy**
    - [Deploy with Kubernetes Manifests](#create-logging-resource-with-psp)
    - [Deploy with Helm](#deploy-with-helm-2)
    - [Output](#example-manifest-generated-by-the-operator-1)
- **Security Context**
    - [Security Context Config Variables](#security-context-config-variables)
    - [Deploy with Kubernetes Manifests](#deploy-with-kubernetes-manifests-3)
    - [Deploy with Helm](#deploy-with-helm-3)
    - [Output](#example-manifest-generated-by-the-operator-2)
---


### Security Variables
| Variable Name | Type | Required | Default | Description |
|---|---|---|---|---|
| roleBasedAccessControlCreate | bool | No | True | create RBAC resources |
| podSecurityPolicyCreate | bool | No | False | create PSP resources |
| serviceAccount | string | No | - | Set ServiceAccount |

## Using [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) Authorization
> By default the rbac is enabled.

### Deploy with Kubernetes Manifests
#### Create `logging` resource with RBAC
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
      roleBasedAccessControlCreate: true
  fluentbit:
    security:
      roleBasedAccessControlCreate: true
  controlNamespace: logging
EOF
```

### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.roleBasedAccessControlCreate=True \
    --set=loggingOperator.fluentbit.security.roleBasedAccessControlCreate=True
```

### Example Manifest Generated by the operator

#### Fluentd Role & RoleBinding Output
``` 
- apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    name: nginx-demo-nginx-logging-demo-logging-fluentd
    namespace: logging
    ownerReferences:
    - apiVersion: logging.banzaicloud.io/v1beta1
      controller: true
      kind: Logging
  rules:
  - apiGroups:
    - ""
    resources:
    - configmaps
    - secrets
    verbs:
    - '*'

--
- apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    annotations:
    name: nginx-demo-nginx-logging-demo-logging-fluentd
    namespace: logging
    ownerReferences:
    - apiVersion: logging.banzaicloud.io/v1beta1
      controller: true
      kind: Logging
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: nginx-demo-nginx-logging-demo-logging-fluentd
  subjects:
  - kind: ServiceAccount
    name: nginx-demo-nginx-logging-demo-logging-fluentd
    namespace: logging


```

#### Fluentbit ClusterRole & ClusterRoleBinding Output
``` 
kind: ClusterRole
metadata:
  annotations:
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
  ownerReferences:
  - apiVersion: logging.banzaicloud.io/v1beta1
    controller: true
    kind: Logging
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - namespaces
  verbs:
  - get
  - list
  - watch

---
kind: ClusterRoleBinding
metadata:
  annotations:
  name: logging-nginx-demo-nginx-logging-demo-logging-fluentbit
  ownerReferences:
  - apiVersion: logging.banzaicloud.io/v1beta1
    controller: true
    kind: Logging
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
subjects:
- kind: ServiceAccount
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
  namespace: logging

```
---

## Service Account ([SA](https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/))
### Deploy with Kubernetes Manifests
#### Create `logging` resource with Service Account
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
      serviceAccount: fluentdUser1
  fluentbit:
    security:
      serviceAccount: fluentbitUser1
  controlNamespace: logging
EOF
```
### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.serviceAccount=fluentdUser1 \
    --set=loggingOperator.fluentbit.security.serviceAccount=fluentbitUser1
```

---
## Enabling Pod Security Policies ([PSP](https://kubernetes.io/docs/concepts/policy/pod-security-policy/))
> This option depends on the roleBasedAccessControlCreate enabled status because the psp require rbac roles also. 

### Deploy with Kubernetes Manifests
#### Create `logging` resource with PSP
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
      podSecurityPolicyCreate: true
      roleBasedAccessControlCreate: true
  fluentbit:
    security:
      podSecurityPolicyCreate: true
      roleBasedAccessControlCreate: true
  controlNamespace: logging
EOF
```
### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.podSecurityPolicyCreate=True \
    --set=loggingOperator.fluentd.security.roleBasedAccessControlCreate=True \
    --set=loggingOperator.fluentbit.security.podSecurityPolicyCreate=True \
    --set=loggingOperator.fluentbit.security.roleBasedAccessControlCreate=True 
```

### Example Manifest Generated by the operator

#### Fluentd PSP+Role Output
``` 
kind: Role
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentd-psp
  namespace: logging
rules:
- apiGroups:
  - policy
  resources:
  - nginx-demo-nginx-logging-demo-logging-fluentd
  verbs:
  - use

---
kind: PodSecurityPolicy
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentd
spec:
  allowPrivilegeEscalation: false
  fsGroup:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  runAsUser:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  volumes:
  - configMap
  - emptyDir
  - secret
  - persistentVolumeClaim


```
#### Fluentbit PSP+ClusterRole Output
```
kind: ClusterRole
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentbit-psp
rules:
- apiGroups:
  - policy
  resources:
  - nginx-demo-nginx-logging-demo-logging-fluentbit
  verbs:
  - use
---
kind: PodSecurityPolicy
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
spec:
  allowPrivilegeEscalation: false
  allowedHostPaths:
  - pathPrefix: /var/lib/docker/containers
    readOnly: true
  - pathPrefix: /var/log
    readOnly: true
  fsGroup:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  readOnlyRootFilesystem: true
  runAsUser:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  volumes:
  - configMap
  - emptyDir
  - secret
  - hostPath
```

## [Security Context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
### Security Context Config Variables
| Variable Name | Type | Required | Default | Description |
|---|---|---|---|---|
| podRunAsNonRoot | bool | No | True | Run as non root |
| podRunAsUser | int | No | False | Controls which user ID the containers are run with. |
| podRunAsGroup | int | No | - | Controls which primary group ID the containers are run with. |
| podFsGroup | int | No | - | Allocating an FSGroup that owns the podâ€™s volumes |
| containerRunAsUser | int | No | - | Controls which user ID the containers are run with. |
| containerRunAsNonRoot | bool | No | - | Run container as non root  |
| containerAllowPrivilegeEscalation | bool | No | - | Allow privilege escalation |
| containerReadOnlyRootFilesystem | bool | No | - | Requiring the use of a read only root file system |
| containerPrivileged | bool | No | - | Running container as privileged |


### Deploy with Kubernetes Manifests
#### Create `logging` resource with PSP
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
        securityContext:
        containerAllowPrivilegeEscalation: false
        containerReadOnlyRootFilesystem: false
        podFsGroup: 65533
  fluentbit:
    security:
      securityContext:
        containerAllowPrivilegeEscalation: false
        containerReadOnlyRootFilesystem: true
        podFsGroup: 65533
  controlNamespace: logging
EOF
```
### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.securityContext.containerAllowPrivilegeEscalation=False \
    --set=loggingOperator.fluentd.security.securityContext.containerReadOnlyRootFilesystem=False \
    --set=loggingOperator.fluentd.security.securityContext.podFsGroup=65533 \
    --set=loggingOperator.fluentbit.security.securityContext.containerAllowPrivilegeEscalation=False \
    --set=loggingOperator.fluentbit.security.securityContext.containerReadOnlyRootFilesystem=True \
    --set=loggingOperator.fluentbit.security.securityContext.podFsGroup=65533
```

### Example Manifest Generated by the operator

``` 
apiVersion: v1
kind: Pod
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentd-0
  namespace: logging
spec:
  containers:
  - image: banzaicloud/fluentd:v1.6.3-alpine-2
    imagePullPolicy: IfNotPresent
    name: fluentd
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
...
  schedulerName: default-scheduler
  securityContext:
    fsGroup: 65533
  serviceAccount: nginx-demo-nginx-logging-demo-logging-fluentd
...
```

